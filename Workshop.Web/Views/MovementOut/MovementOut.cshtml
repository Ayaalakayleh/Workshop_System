@using Workshop.Resources;

@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Common> Common
@inject IStringLocalizer<Messages> Message

@model Workshop.Core.DTOs.Vehicle.VehicleMovement;
<link href="~/js/literallycanvas/_assets/literallycanvas.css" rel="stylesheet" />

<style>
    :root {
        --card-radius: 14px;
        --card-shadow: 0 6px 20px rgba(0,0,0,.06);
        --card-shadow-hover: 0 12px 30px rgba(0,0,0,.12);
    }

    .VehicleInfo {
        display: none;
    }

    .agreement-panel {
        border-left: 10px solid var(--primary, var(--theme-primary));
        border-radius: 10px !important;
    }

    #signatureparent {
        color: darkblue;
        background-color: darkgrey;
        padding: 20px;
    }

    /* Signature canvas wrapper */
    .signature {
        border: 2px dotted black;
        background-color: lightgrey;
        height: 310px;
    }

        .signature canvas {
            height: 310px !important;
        }

    #content img {
        display: none !important;
    }

    .literally {
        width: 100%;
        height: 600px !important;
        position: relative;
    }

    /* Fieldset theme (match MovementIn) */
    .ui-fieldset {
        border: 2px dashed var(--primary-100, #e5e7eb);
        border-radius: .75rem;
        padding: 1rem 1.25rem;
    }

        .ui-fieldset > legend {
            color: var(--primary-700, var(--primary));
            font-weight: 600;
            font-size: .9rem;
            padding: 0 .5rem;
        }

    .select2-dropdown, .select2-dropdown--above {
        z-index: 999999999999 !important;
    }

    .invalid {
        background-color: #ffdddd !important;
        border: 1px solid red !important;
    }

    .modal-dialog.modal-transparent .modal-body .form-group .filepond--drop-label.filepond--drop-label label {
        color: #000 !important;
    }

    .modal-footer {
        background: radial-gradient(black, transparent);
        position: fixed;
        bottom: 0;
        right: 0;
        z-index: 999;
        left: 0;
    }

    #vehicleList {
        height: 558px;
        overflow: hidden;
        overflow-y: scroll;
    }

    .accidents-images img {
        height: 300px;
    }

    .accidents-images {
        box-shadow: 0px 0px 13px 0px rgb(62 44 90 / 8%);
        cursor: grab;
    }

    .lc-picker, .lc-options {
        display: none;
    }

    /* === Vehicle hero (borrowed from MovementIn) === */
    .vehicle-hero {
        margin-bottom: 1rem;
    }

    .vehicle-hero__card {
        border-radius: var(--card-radius);
        background: #fff;
        box-shadow: var(--card-shadow);
        padding: 1rem 1.25rem;
        border: 1px solid rgba(0,0,0,.04);
    }

    .vehicle-hero__grid {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr) minmax(0, 1.6fr);
        gap: 1rem;
        align-items: stretch;
    }

    @@media (max-width: 991.98px) {
        .vehicle-hero__grid

    {
        grid-template-columns: 1fr;
    }

    }

    .vehicle-hero__facts {
        display: flex;
        flex-direction: column;
        gap: .5rem;
    }

    .vehicle-hero__row {
        display: flex;
        gap: 1rem;
    }

    .vehicle-hero__fact {
        flex: 1;
        min-width: 0;
    }

    .vehicle-hero__label {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .04em;
        color: #6c757d;
        margin-bottom: .15rem;
    }

    .vehicle-hero__value {
        font-weight: 600;
        font-size: .95rem;
    }

    .vehicle-hero__meta {
        display: flex;
        flex-wrap: wrap;
        gap: .75rem;
        margin-top: .25rem;
        font-size: .8rem;
        color: #6c757d;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: .35rem;
    }

        .meta-item i {
            font-size: .9rem;
        }

    .vehicle-hero__status {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .status-stack {
        display: flex;
        flex-direction: column;
        gap: .5rem;
        width: 100%;
    }

    .status-btn {
        border-radius: .75rem;
        border: 1px solid rgba(0,0,0,.06);
        padding: .5rem .75rem;
        display: flex;
        align-items: center;
        gap: .5rem;
        background: #f9fafb;
        transition: all .18s ease;
        cursor: pointer;
    }

        .status-btn img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .status-btn span {
            font-size: .9rem;
            color: #374151;
        }

    .maintenance-radio {
        display: none;
    }

        .maintenance-radio:checked + .status-btn {
            border-color: var(--primary-600, var(--primary));
            background: color-mix(in srgb, var(--primary-50, #eff6ff) 84%, #ffffff 16%);
            box-shadow: 0 0 0 1px color-mix(in srgb, var(--primary-600, var(--primary)) 40%, transparent);
        }

            .maintenance-radio:checked + .status-btn span {
                color: var(--primary-700, var(--primary));
                font-weight: 600;
            }

    .customer-card {
        border-radius: .75rem;
        border: 1px solid rgba(0,0,0,.06);
        padding: .75rem .85rem;
        display: flex;
        gap: .75rem;
        align-items: flex-start;
        background: #f9fafb;
        height: 100%;
    }

    .customer-card__icon {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e5f0ff;
        color: var(--primary-600, var(--primary));
        font-size: 1.25rem;
    }

    .customer-card__body h4 {
        font-size: .9rem;
        margin: 0 0 .25rem 0;
        font-weight: 500;
    }

        .customer-card__body h4 .val {
            font-weight: 600;
        }

    /* === Scratch canvas + cursors (aligned with MovementIn, keep your dimensions) === */
    .mark-scratces-section {
        margin-top: .5rem;
    }

    .scratch-controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: .5rem;
        margin-bottom: .75rem;
    }

    .scratches-container {
        display: flex;
        justify-content: center;
    }

    .mark-scratces-section #panel,
    .mark-scratces-section #panel-edit,
    #panel-canvas {
        position: relative;
        width: 1000px;
        height: 500px;
        border: 1px dashed #ccc;
        border-radius: .5rem;
        background-image: url('@Url.Content("../images/tajeer-car-assets/tajeer-car.jpeg")');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        padding: 45px;
        background-origin: content-box;
        background-color: #f5f5f5;
        margin: 0 auto;
    }

    #panel.deep-scratch-cursor {
        cursor: url('@Url.Content("~/images/tajeer-car-assets/DeepScratch.png")') 16 16, auto;
    }

    #panel.small-scratch-cursor {
        cursor: url('@Url.Content("~/images/tajeer-car-assets/MinorScratch.png")') 16 16, auto;
    }

    #panel.very-deep-cursor {
        cursor: url('@Url.Content("~/images/tajeer-car-assets/VeryDeepScratch.png")') 16 16, auto;
    }

    #panel.bend-body-cursor {
        cursor: url('@Url.Content("~/images/tajeer-car-assets/CurvatureStructure.png")') 16 16, auto;
    }

    .mark-scratces-section .shape {
        position: absolute;
    }

    .shape {
        z-index: 999999 !important;
        width: 30px;
        height: 30px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }

    /* Per damage type icons (keep your existing IDs to match JS) */
    .mark-scratces-section #deep-scratch {
        background-image: url('@Url.Content("~/images/tajeer-car-assets/DeepScratch.png")');
    }

    .mark-scratces-section #small-scratch {
        background-image: url('@Url.Content("~/images/tajeer-car-assets/MinorScratch.png")');
    }

    .mark-scratces-section #very-deep-scratch {
        background-image: url('@Url.Content("~/images/tajeer-car-assets/VeryDeepScratch.png")');
    }

    .mark-scratces-section #bend-in-body {
        background-image: url('@Url.Content("~/images/tajeer-car-assets/CurvatureStructure.png")');
    }
</style>

<div class="row">
    <div class="col-12">
        <div id="panel-1" class="panel">
            <div class="panel-hdr">
                <h2 class="font-weight-bold">@Common["MovementOut"]</h2>
            </div>
            <div class="panel-container show">
                <div class="panel-content">
                    @{
                        var count = 0;
                    }
                    @using (Html.BeginForm("MoveOutWorkShop", "VehicleMovements", FormMethod.Post, new { enctype = "multipart/form-data", id = "formMoveOutWorkShop" }))
                    {
                        @Html.HiddenFor(a => a.MovementId)
                        @Html.HiddenFor(a => a.VehicleID)
                        @Html.HiddenFor(a => a.ExitBranchId)
                        @Html.HiddenFor(a => a.WorkshopId)
                        @Html.HiddenFor(a => a.ReceivedMeter)
                        @Html.HiddenFor(a => a.MasterId)
                        @Html.HiddenFor(a => a.ReceivedMeter)
                        @Html.HiddenFor(a => a.TotalWorkOrder)
                        @Html.HiddenFor(a => a.IsRegularMaintenance)
                        @Html.HiddenFor(a => a.LastVehicleStatus)
                        @Html.HiddenFor(a => a.IsExternal)
                        @Html.HiddenFor(a => a.WorkOrderId)

                        <input type="hidden" id="WorkshopMovDmg" name="WorkshopMovDmg" value="" />

                        <!-- === VEHICLE HERO HEADER (styled like MovementIn) === -->
                        <div class="vehicle-hero">
                            <div class="vehicle-hero__card">
                                <div class="vehicle-hero__grid">
                                    <!-- Vehicle facts -->
                                    <div class="vehicle-hero__facts">
                                        <div class="vehicle-hero__row">
                                            <div class="vehicle-hero__fact">
                                                <div class="vehicle-hero__label">@Common["VehicleClass"]</div>
                                                <div class="vehicle-hero__value">
                                                    <label id="VehicleClass"></label>
                                                </div>
                                            </div>
                                            <div class="vehicle-hero__fact">
                                                <div class="vehicle-hero__label">@Common["Manufacturer"]</div>
                                                <div class="vehicle-hero__value">
                                                    <label id="VehicleManufacturer"></label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="vehicle-hero__row">
                                            <div class="vehicle-hero__fact">
                                                <div class="vehicle-hero__label">@Common["PlateNumber"]</div>
                                                <div class="vehicle-hero__value">
                                                    <label id="VehiclePlateNo"></label>
                                                </div>
                                            </div>
                                            <div class="vehicle-hero__fact">
                                                <div class="vehicle-hero__label">@Common["Model"]</div>
                                                <div class="vehicle-hero__value">
                                                    <label id="VehicleModel"></label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="vehicle-hero__meta">
                                            <div class="meta-item">
                                                <i class="fal fa-calendar"></i>
                                                <span>@Common["MovementDate"]</span>
                                                <b>@Model.GregorianMovementDate?.ToString("yyyy-MM-dd")</b>
                                            </div>
                                            <div class="meta-item">
                                                <i class="fal fa-tachometer"></i>
                                                <span>@Common["ReceivedMeter"]</span>
                                                <b>@Model.ReceivedMeter</b>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Status radios styled like MovementIn -->
                                    <div class="vehicle-hero__status">
                                        <div class="status-stack" role="group" aria-label="maintenance-type">
                                            <label class="w-100 mb-0">
                                                <input data-val="false"
                                                       name="Type"
                                                       type="radio"
                                                       value="option1"
                                                       class="maintenance-radio"
                                                       @(Model.IsRegularMaintenance == true ? "checked" : "") />
                                                <div class="status-btn">
                                                    <img src="~/images/maintenance1.png" alt="">
                                                    <span>@Common["RegularMaintenance"]</span>
                                                </div>
                                            </label>

                                            <label class="w-100 mb-0">
                                                <input data-val="false"
                                                       name="Type"
                                                       type="radio"
                                                       value="option2"
                                                       class="maintenance-radio"
                                                       @(Model.IsRegularMaintenance == false ? "checked" : "") />
                                                <div class="status-btn">
                                                    <img src="~/images/insurance1.png" alt="">
                                                    <span>@Common["Insurance "]</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Customer card styled -->
                                    <div>
                                        <div class="customer-card">
                                            <div class="customer-card__icon" aria-hidden="true">
                                                <i class="fal fa-user-circle"></i>
                                            </div>
                                            <div class="customer-card__body">
                                                <h4>
                                                    @Common["CustomerName"]:
                                                    <span class="val"><label id="customerName"></label></span>
                                                </h4>
                                                <h4>
                                                    @Common["PhoneNo"]:
                                                    <span class="val"><label id="CustomerPhone"></label></span>
                                                </h4>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <!-- === END VEHICLE HERO === -->

                        <div class="row">
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <fieldset class="mt-3 ui-fieldset">
                                    <legend>@Common["MaintenanceTypes"]</legend>
                                    <div class="row">
                                        <div id="MaintenanceCard" class="col-12 mt-3">
                                            <table class="table table-bordered table-hover w-100 text-center" id="tblMainteneance">
                                                <thead>
                                                    <tr>
                                                        <th>@Common["MaintenanceTypes"]</th>
                                                        <th>@Common["Description"]</th>
                                                        <th>@Common["Status"]</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tblData">
                                                    @foreach (var item in Model.ColMaintenanceCard)
                                                    {
                                                        <tr>
                                                            <td>
                                                                <select id="MaintenanceType_@count" class="form-control select2" disabled>
                                                                    @foreach (var work in Model.WorkOrders)
                                                                    {
                                                                        if (work.Id == item.WorkOrderId)
                                                                        {
                                                                            <option value="@work.Id" selected>@work.WorkOrderTitle</option>
                                                                        }
                                                                        else
                                                                        {
                                                                            <option value="@work.Id">@work.WorkOrderTitle</option>
                                                                        }
                                                                    }
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <input type="text"
                                                                       readonly
                                                                       id="MaintenanceDesc_@count"
                                                                       name="MaintenanceDesc_@count"
                                                                       class="form-control"
                                                                       value="@item.Description" />
                                                            </td>
                                                            <td>
                                                                @if (item.status == true)
                                                                {
                                                                    <div class="custom-control custom-switch custom-control-inline my-1">
                                                                        <input type="checkbox"
                                                                               class="custom-control-input"
                                                                               id="switchh_@count"
                                                                               name="MainteneanceStatus_@count"
                                                                               value="@item.status"
                                                                               checked />
                                                                        <label class="custom-control-label align-middle" for="switchh_@count">@Common["Done"]</label>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <div class="custom-control custom-switch custom-control-inline my-1">
                                                                        <input type="checkbox"
                                                                               class="custom-control-input"
                                                                               id="switchh_@count"
                                                                               name="MainteneanceStatus_@count"
                                                                               value="@item.status" />
                                                                        <label class="custom-control-label align-middle" for="switchh_@count">@Common["Done"]</label>
                                                                    </div>
                                                                }
                                                            </td>
                                                            <td style="display:none;">
                                                                <input type="hidden" value="@item.MovementId" id="MaintenanceMovementId_@count" />
                                                            </td>
                                                        </tr>
                                                        count++;
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>

                            <div class="col-lg-6 col-md-12 col-sm-12 mt-3">
                                <fieldset class="ui-fieldset">
                                    <legend>@Common["Movement In"]</legend>
                                    <div class="row">
                                        <div class="col-lg-6">
                                            @Html.AntiForgeryToken()
                                            <div class="form-group">
                                                <label>@Common["Movement Date"]</label>
                                                <div class="input-group">
                                                    @Html.EditorFor(model => model.GregorianMovementDate, new { htmlAttributes = new { @class = "form-control flat-picker", id = "GregorianMovementDate" } })
                                                    @Html.EditorFor(model => model.hijriMovementDate, new { htmlAttributes = new { style = "display:none" } })
                                                    <div class="input-group-append">
                                                        <span class="input-group-text fs-xl">
                                                            <i class="fa fa-calendar-alt"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group mt-2">
                                                <label>@Common["ExitTime"]</label>
                                                @Html.EditorFor(model => model.ExitTime, new { htmlAttributes = new { @type = "time", @class = "form-control", id = "ExitTime" } })
                                            </div>
                                        </div>

                                        <div class="col-lg-6">
                                            <div class="form-group">
                                                <label>@Common["ExitMeter"]</label>
                                                @Html.TextBoxFor(a => a.ExitMeter, htmlAttributes: new { @class = "form-control", id = "ExitMeter" })
                                            </div>

                                            <div class="form-group mt-2">
                                                <label>@Common["Driver"]</label>
                                                <input type="text" id="ExitDriverName" name="ExitDriverId" class="form-control">
                                            </div>
                                        </div>

                                        <div class="col-lg-6">
                                            <div class="form-group">
                                                <label>@Common["VehicleSubStatus"]</label>
                                                @Html.DropDownListFor(
                                                a => a.VehicleSubStatusId,
                                                                                        new SelectList(Model.RefVehicledefinitions.ColVehicleSubStatus, "Id", "Name"),
                                                                                        Common["Select"],
                                                                                        htmlAttributes: new { @class = "form-control select2", style = "width: 100%;", id = "VehicleSubStatusId" })
                                        </div>
                                    </div>

                                    <div class="col-lg-6">
                                        <div class="form-group">
                                            <label>@Common["TotalCost"]</label>
                                            @Html.TextBoxFor(a => a.TotalCost, htmlAttributes: new { @class = "form-control", id = "TotalCost" })
                                        </div>
                                    </div>

                                    <div class="col-lg-6">
                                        <div class="form-group">
                                            <div id="fuelMeterDiv2"></div>
                                            <br />
                                            <div id="fuelSliderDiv2"></div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 my-3">
                            <fieldset class="ui-fieldset">
                                <legend>@Common["MovementIn"] - @Common["Damage"]</legend>
                                <div class="row mark-scratces-section">
                                    <div class="col-xl-9 col-lg-12 col-md-12 col-sm-12 border-left">
                                        <div class="scratch-controls text-center">
                                            <button type="button" class="btn btn-outline-primary btn-sm btn-w-m damage-btn" id="DeepScratch-btn">
                                                <img src="~/images/tajeer-car-assets/DeepScratch.png" />&nbsp;Deep Scratch
                                            </button>
                                            <button type="button" class="btn btn-outline-warning btn-sm btn-w-m damage-btn" id="SmallScratch-btn">
                                                <img src="~/images/tajeer-car-assets/MinorScratch.png" />&nbsp;Small Scratch
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm btn-w-m damage-btn" id="VeryDeepScratch-btn">
                                                <img src="~/images/tajeer-car-assets/VeryDeepScratch.png" />&nbsp;Very Deep Scratch
                                            </button>
                                            <button type="button" class="btn btn-outline-dark btn-sm btn-w-m damage-btn" id="BendInBody-btn">
                                                <img src="~/images/tajeer-car-assets/CurvatureStructure.png" />&nbsp;Bend in Body
                                            </button>
                                        </div>

                                        <div class="scratches-container">
                                            <div id="panel" class="mt-3"></div>
                                        </div>

                                        <div class="text-center mt-3">
                                            <button type="button" class="btn btn-secondary btn-sm btn-w-m" id="undo-button">
                                                <i class="fa fa-history"></i>&nbsp;Undo
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm btn-w-m" id="clear-button">
                                                <i class="fa fa-times"></i>&nbsp;Clear
                                            </button>
                                        </div>

                                        <div id="coordinates" class="d-none"></div>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <a href="@Url.Action("Index", "Movements")" class="btn btn-secondary btn-w-m">
                            <i class="fa fa-arrow-left"></i>&nbsp;@Common["Button_BackToList"]
                        </a>
                        <button type="button" id="btnCreate" onclick="ValidOut();" class="btn btn-primary btn-w-m">
                            <i class="fa fa-save"></i>&nbsp;@Common["Button_Save"]
                        </button>
                    </div>
                                        }
                </div>
            </div>
        </div>
    </div>
</div>
<script src="~/js/site.js"></script>

<script>
    $(document).ready(function () {
        /* Start Scratches js */
        var d = new Date(),
            h = d.getHours(),
            m = d.getMinutes();

        if (h < 10) h = '0' + h;
        if (m < 10) m = '0' + m;

        $('#ExitTime').val(h + ":" + m);

        function updateDamageHidden() {
            $('#WorkshopMovDmg').val(JSON.stringify(shapesJson));
        }

        function resetCursorClasses() {
            $("#panel").removeClass("deep-scratch-cursor small-scratch-cursor very-deep-cursor bend-body-cursor");
        }

        var shapesJson = [];
        var shapeType;
        var xCoord;
        var yCoord;
        var shapeCount = 0;

        var undoButton = $('#undo-button');
        var clearButton = $('#clear-button');

        $('#DeepScratch-btn').click(function () {
            shapeType = 'deep-scratch';
            $('#coordinates').text('DeepScratch coordinates: ');
            resetCursorClasses();
            $("#panel").addClass("deep-scratch-cursor");
        });

        $('#SmallScratch-btn').click(function () {
            shapeType = 'small-scratch';
            $('#coordinates').text('SmallScratch coordinates: ');
            resetCursorClasses();
            $("#panel").addClass("small-scratch-cursor");
        });

        $('#VeryDeepScratch-btn').click(function () {
            shapeType = 'very-deep-scratch';
            $('#coordinates').text('VeryDeepScratch coordinates: ');
            resetCursorClasses();
            $("#panel").addClass("very-deep-cursor");
        });

        $('#BendInBody-btn').click(function () {
            shapeType = 'bend-in-body';
            $('#coordinates').text('BendInBody coordinates: ');
            resetCursorClasses();
            $("#panel").addClass("bend-body-cursor");
        });

        // Get existing strikes
        $.ajax({
            type: "GET",
            url: "@Url.Action("GetStrike", "Movements")" + '?MovementId=' + '@Model.MovementId',
            dataType: "text",
            success: function (Data) {
                if (!Data || Data === "") return;

                var jsonObject;
                try {
                    jsonObject = (typeof Data === 'string') ? JSON.parse(Data) : Data;
                } catch (e) {
                    jsonObject = Data;
                }

                if (!jsonObject || !jsonObject.length) return;

                for (var i = 0; i < jsonObject.length; i++) {
                    var shapeTypeLocal = jsonObject[i].type;
                    var xCoordLocal = jsonObject[i].x + 35;
                    var yCoordLocal = jsonObject[i].y + 23;

                    var $shape = $('<div class="shape shape-' + i + '" id="' + shapeTypeLocal + '"></div>');
                    $shape.css({ 'left': xCoordLocal - 2, 'top': yCoordLocal - 2 });

                    $("#panel").append($shape);

                    shapesJson.push({
                        "type": "" + shapeTypeLocal + "",
                        "x": xCoordLocal - 35,
                        "y": yCoordLocal - 23
                    });
                }

                updateDamageHidden();
            }
        });

        // Add new strike
        $('#panel').click(function (e) {
            if (!shapeType) return;

            var id = ++shapeCount;
            xCoord = e.pageX - $(this).offset().left;
            yCoord = e.pageY - $(this).offset().top;

            var $shape = $('<div class="shape shape-' + id + '" id="' + shapeType + '"></div>');
            $shape.css({ 'left': xCoord - 2, 'top': yCoord - 2 });

            $(this).append($shape);

            $('#coordinates').append(shapeType + ': (' + xCoord + ', ' + yCoord + ') ');
            shapesJson.push({
                "type": "" + shapeType + "",
                "x": xCoord - 35,
                "y": yCoord - 23
            });

            updateDamageHidden();
        });

        // Undo
        undoButton.on('click', function () {
            var lastShape = shapesJson.pop();
            if (lastShape) {
                $('.shape:last-child').remove();
                updateDamageHidden();
            }
        });

        // Clear
        clearButton.on('click', function () {
            shapesJson = [];
            $("#panel").empty();
            updateDamageHidden();
        });

        /* End Scratches js */

        GetVehicleData();

        $("#ExitMeter").val(parseFloat($("#ReceivedMeter").val()) + 1);

        document.querySelectorAll('input[name="Type"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const isRegularMaintenance = this.value === 'option1';
                $('#IsRegularMaintenance').val(isRegularMaintenance);
            });
        });
    });

    var rowCount = $('#tblMainteneance  >tbody >tr').length;

    function toBool(v) {
        if (typeof v === "boolean") return v;
        if (typeof v === "number") return v === 1;
        if (typeof v === "string") {
            var s = v.trim().toLowerCase();
            return (s === "true" || s === "1" || s === "yes" || s === "ok");
        }
        return false;
    }

    function getSuccessFlag(resp) {
        // resp might be: {isSuccess:true} OR {IsSuccess:true} OR {success:true} OR plain true/1/"true"
        if (resp && typeof resp === "object") {
            return toBool(resp.IsSuccess ?? resp.isSuccess ?? resp.success ?? resp.Success ?? resp.ok);
        }
        return toBool(resp);
    }

    function getMessage(resp) {
        if (!resp || typeof resp !== "object") return "";
        return resp.Message ?? resp.message ?? resp.error ?? resp.Error ?? "";
    }

    function ValidOut() {
        var isValid = true;

        if ($("#OutfuelLevelId").val() == "") {
            $("#OutfuelLevelId").next().children(':first-child').children(':first-child').css("border-color", "red");
            isValid = false;
        }

        if ($("#ExitMeter").val() == "" || $("#ExitMeter").val() == 0) {
            $("#ExitMeter").addClass("invalid");
            isValid = false;
        } else if (parseFloat($("#ExitMeter").val()) < parseFloat($("#ReceivedMeter").val())) {
            $("#ExitMeter").addClass("invalid");

            alert(
                '@Common["Error"]' + "\n" +
                '@Common["OdometerMustMatchTheVreviousReadingOrExceedsIt"]' +
                " : " + parseInt($("#ReceivedMeter").val()) + " " + '@Common["KiloMeter"]'
            );

            $("#ExitMeter").focus();
            isValid = false;
        } else {
            $("#ExitMeter").removeClass("invalid");
        }

        if ($("#ExitDriverName").val() == "") {
            $("#ExitDriverName").addClass("invalid");
            isValid = false;
        }

        if ($("#VehicleSubStatusId").val() == "" || $("#VehicleSubStatusId").val() == 0) {
            $("#VehicleSubStatusId").next().children().children().addClass("invalid");
            isValid = false;
        } else {
            $("#VehicleSubStatusId").next().children().children().removeClass("invalid");
        }

        var cards = [];
        var i = 0;
        $('#tblMainteneance > tbody  > tr').each(function () {
            cards.push({
                'DamageId': $(this).find('#MaintenanceType_' + i).val(),
                'Description': $(this).find('#MaintenanceDesc_' + i).val(),
                'status': $(this).find('#switchh_' + i).is(":checked"),
                'MovementId': $(this).find('#MaintenanceMovementId_' + i).val()
            });
            i = i + 1;
        });

        // Make bool parsing robust (handles "True"/"False" too)
        var isRegularMaintenanceVal = String($('#IsRegularMaintenance').val() ?? '').toLowerCase() === 'true';
        var isExternalVal = String($('#IsExternal').val() ?? '').toLowerCase() === 'true';

        var movement = {
            MovementInId: parseInt($('#MovementId').val()) || null,
            InvoiceId: parseInt('@Model.InvoiceId') || null,
            VehicleID: parseInt($('#VehicleID').val()) || null,
            ReceivedBranchId: parseInt($('#ExitBranchId').val()) || null,
            MoveOutWorkshopId: parseInt($('#WorkshopId').val()) || null,
            TotalWorkOrder: parseFloat($('#TotalWorkOrder').val()) || null,
            WorkshopId: parseInt($('#WorkshopId').val()) || null,
            ReceivedMeter: parseFloat($('#ReceivedMeter').val()) || null,
            MasterId: $('#MasterId').val() || null,
            ExitMeter: parseFloat($('#ExitMeter').val()) || null,
            FuelLevelId: parseInt($("#OutfuelLevelId").val()) || null,
            ExitDriverId: $('#ExitDriverName').val() || null,
            IsRegularMaintenance: isRegularMaintenanceVal,
            strikes: $('#WorkshopMovDmg').val() || null,
            LastVehicleStatus: parseInt($('#LastVehicleStatus').val()) || null,
            ColMaintenanceCard: cards,
            IsExternal: isExternalVal,
            GregorianMovementDate: $("#GregorianMovementDate").val() || null,
            ExitTime: $('#ExitTime').val() || null,
            TotalCost: parseFloat($('#TotalCost').val()) || null,
            VehicleSubStatusId: parseInt($("#VehicleSubStatusId").val()) || null,
            WorkOrderId: parseInt($("#WorkOrderId").val()) || null
        };

        if (isValid) {
            $.ajax({
                type: "POST",
                url: "@Url.Action("MoveOut", "MovementOut")",
                data: JSON.stringify(movement),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (data, textStatus, xhr) {
                    // Debug: see the real response in console
                    console.log("MoveOut response:", data);

                    var ok = getSuccessFlag(data);

                    // Some APIs return empty body with 200 OK (ok should be true in that case)
                    if (!ok && (data == null || data === "")) {
                        ok = (xhr && xhr.status >= 200 && xhr.status < 300);
                    }

                    if (ok) {
                        window.location.href = "@Url.Action("Index", "Movements")";
                    } else {
                        var msg = getMessage(data) || "Failed (response didn't include success flag). Check console log.";
                        alert(msg);
                    }
                },
                error: function (xhr) {
                    // This will show you the actual server response if JSON parse failed or server returned HTML/text
                    console.log("MoveOut error:", xhr.status, xhr.responseText);
                    alert("Error from Api: " + xhr.status);
                }
            });
        }
    }

    function GetVehicleData() {
        var type = '@Model.IsExternal' == 'True' ? 2 : 1;

        $.ajax({
            type: "GET",
            url: "@Url.Action("GetDetails", "VehicleDefinition")" + '?id=' + $("#VehicleID").val() + "&Type=" + type,
            dataType: "JSON",
            success: function (Data) {
                $("#VehicleManufacturer").text(Data.RefManufacturers.ManufacturerPrimaryName);
                $("#VehicleClass").text(Data.RefVehicleClasses.VehicleClassPrimaryName);
                $("#VehiclePlateNo").text(Data.PlateNumber);
                $("#VehicleModel").text(Data.RefVehicleModels.VehicleModelPrimaryName);
            }
        });
    }
</script>

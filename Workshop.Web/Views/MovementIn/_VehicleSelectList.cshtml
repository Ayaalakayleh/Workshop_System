@using Microsoft.Extensions.Localization
@using Workshop.Resources
@model List<Workshop.Core.DTOs.Vehicle.VehicleDefinitions>

@inject IStringLocalizer<Common> Common
@inject IStringLocalizer<Messages> Message

@{
    var lang = "en";
}

<style>
    :root {
        --card-radius: 14px;
        --card-shadow: 0 6px 20px rgba(0,0,0,.06);
        --card-shadow-hover: 0 12px 30px rgba(0,0,0,.12);
    }


    .vehicle-card-container {
        display: flex;
    }

    /* Card */
    .vehicle-card {
        position: relative;
        width: 100%;
        border-radius: var(--card-radius);
        background: #fff;
        box-shadow: var(--card-shadow);
        transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
        border: 1px solid rgba(0,0,0,.06);
        overflow: hidden;
        cursor: pointer;
    }

        .vehicle-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--card-shadow-hover);
        }

        /* Selection visuals (use --primary-600, fallback to --primary) */
        .vehicle-card.selected {
            border-color: var(--primary-600, var(--primary));
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-600, var(--primary)) 22%, transparent);
        }

    .vehicle-select-hit {
        position: absolute;
        inset: 0;
        z-index: 4;
        opacity: 0;
        /* keep it clickable to preserve radio semantics */
    }

    .vehicle-overlay {
        position: absolute;
        inset: 0;
        background: color-mix(in srgb, var(--primary-600, var(--primary)) 18%, transparent);
        opacity: 0;
        transition: opacity .18s ease;
        z-index: 2;
    }

    .vehicle-card.selected .vehicle-overlay {
        opacity: .28;
    }

    /* Check icon (top-right) */
    .vehicle-check {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 3;
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0,0,0,.15);
        transform: scale(.9);
        opacity: 0;
        transition: .18s ease;
        color: var(--primary-600, var(--primary));
    }

        .vehicle-check svg {
            width: 18px;
            height: 18px;
        }

    .vehicle-card.selected .vehicle-check {
        transform: scale(1);
        opacity: 1;
    }

    /* Media */
    .vehicle-media {
        width: 100%;
        aspect-ratio: 16/9;
        background: #f6f7f9;
        display: block;
        object-fit: cover;
    }

    /* Body */
    .vehicle-body {
        padding: 12px 14px 14px 14px;
    }

    .vehicle-title {
        margin: 0 0 6px 0;
        font-weight: 700;
        font-size: 1.05rem;
        line-height: 1.25rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Badges row */
    .badge-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: nowrap;
    }

    .pill {
        --pad-x: .55rem;
        --pad-y: .18rem;
        padding: var(--pad-y) var(--pad-x);
        border-radius: 999px;
        font-size: .75rem;
        line-height: 1;
        background: var(--primary);
        color: #fff;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .pill-neutral {
        background: #eef1f7;
        color: #425466;
    }

    /* Specs */
    .spec {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: .92rem;
        padding: 6px 0;
        border-top: 1px dashed rgba(0,0,0,.06);
    }

        .spec:first-of-type {
            border-top: none;
            padding-top: 0;
        }

    .spec-label {
        color: #6c757d;
    }

    .spec-value {
        color: var(--primary);
        font-weight: 600;
    }

    /* (button styles kept only in case used elsewhere) */
    .select-vehicle-btn:disabled {
        cursor: not-allowed;
        opacity: .6;
    }
</style>

<div class="row g-3" id="vehicleList">
    @foreach (var item in Model)
    {
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 vehicle-card-container">
            <div class="vehicle-card" data-vehicle-id="@item.Id">
                <!-- Invisible radio to keep form semantics -->
                <input type="radio" class="vehicle-select-hit choosebtn" value="@item.Id" name="selectedVehicleId" />

                <!-- Selection visuals -->
                <div class="vehicle-overlay"></div>
                <div class="vehicle-check" aria-hidden="true">
                    <!-- Inline SVG: no FA dependency -->
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 6L9 17l-5-5"></path>
                    </svg>
                </div>

                <!-- Image -->
                <img class="vehicle-media"
                     src="/Workshop/Content/smart_theme/dist/img/default_car_260.jpeg"
                     alt="@(lang == "en" ? item.RefManufacturers?.ManufacturerPrimaryName : item.RefManufacturers?.ManufacturerSecondaryName) @(lang == "en" ? item.RefVehicleModels?.VehicleModelPrimaryName : item.RefVehicleModels?.VehicleModelSecondaryName)"
                     loading="lazy" />

                <!-- Body -->
                <div class="vehicle-body">
                    <h3 class="vehicle-title">
                        @(lang == "en" ? item.RefManufacturers?.ManufacturerPrimaryName : item.RefManufacturers?.ManufacturerSecondaryName)
                        @(lang == "en" ? item.RefVehicleModels?.VehicleModelPrimaryName : item.RefVehicleModels?.VehicleModelSecondaryName)
                    </h3>

                    <div class="badge-row">
                        <span class="pill">
                            <i class="fa fa-calendar"></i>@item.ManufacturingYear
                        </span>
                        <span class="pill pill-neutral" title="@item.PlateNumber">
                            <svg height="14" viewBox="0 -88 464.008 464" width="14" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path fill="currentColor" d="m432 32.003906h-400v224h400zM80 48h16v16H80zm16 192H80v-16h16zm32-56c13.23 0 24-10.77 24-24h16c0 22.06-17.95 40-40 40s-40-17.94-40-40v-32c0-22.05 17.95-40 40-40s40 17.95 40 40h-16c0-13.23-10.77-24-24-24s-24 10.77-24 24v32c0 13.23 10.77 24 24 24zm56-48h48v16h-48zm112-8c0 6.17-2.41 11.74-6.24 16 3.84 4.26 6.24 9.83 6.24 16v16c0 13.23-10.77 24-24 24h-40v-16h40c4.41 0 8-3.59 8-8v-16c0-4.41-3.59-8-8-8h-24v-16h24c4.41 0 8-3.59 8-8v-16c0-4.41-3.59-8-8-8h-40v-16h40c13.23 0 24 10.77 24 24zm80 56v16h-64v-19.31l39.03-39.03C401.82 146.89 405 139.2 405 131.02c0-8.82-7.18-16-16-16s-16 7.18-16 16v8h-16v-8c0-17.65 14.35-32 32-32s32 14.35 32 32c0 12.46-4.85 24.17-13.66 32.97l-31.03 31.03zm16 0h16v-80h-16v-16h32v96h16v16h-48z" />
                                <path fill="currentColor" d="M464 .004H0v288h464.008zm-16 272h-432v-256h432z" />
                            </svg>
                            <span class="text-truncate" style="max-width:130px; display:inline-block;">@item.PlateNumber</span>
                        </span>
                    </div>

                    <div class="spec">
                        <span class="spec-label">@Common["Status"]</span>
                        <span class="spec-value">@((lang == "en" ? item.RefVehicleStatus?.VehicleStatusPrimaryName : item.RefVehicleStatus?.VehicleStatusSecondaryName) ?? "N/A")</span>
                    </div>
                    <div class="spec">
                        <span class="spec-label">@Common["Color"]</span>
                        <span class="spec-value">@((lang == "en" ? item.RefVehicleColor?.VehiclePrimaryName : item.RefVehicleColor?.VehicleSecondaryName) ?? "N/A")</span>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script>
    $(function () {

        // Click anywhere on the card to select + submit
        $(document).on('click', '.vehicle-card', function (e) {
            // Ignore clicks on the radio itself; it has its own handler
            if ($(e.target).is('input[type="radio"]')) {
                return;
            }

            const $card = $(this);
            const vehicleId = $card.data('vehicle-id');
            selectAndSubmit($card, vehicleId);
        });

        // Click on the radio overlay
        $(document).on('click', '.choosebtn', function (e) {
            e.stopPropagation();
            const $card = $(this).closest('.vehicle-card');
            const vehicleId = $card.data('vehicle-id');
            selectAndSubmit($card, vehicleId);
        });

        function selectAndSubmit($card, vehicleId) {
            // Clear old selection
            $('.vehicle-card.selected')
                .removeClass('selected')
                .find('.choosebtn')
                .prop('checked', false);

            // Apply new selection visuals + radio
            $card
                .addClass('selected')
                .find('.choosebtn')
                .prop('checked', true);

            // Notify parent / page immediately
            if (window.parent && typeof window.parent.handleVehicleSelection === 'function') {
                window.parent.handleVehicleSelection(vehicleId);
            } else {
                $(document).trigger('vehicleSelected', [vehicleId]);
            }

            // Close Bootstrap modal (if this is inside one)
            $('.modal').modal('hide');
        }

        // ESC closes modal
        $(document).on('keydown', function (e) {
            if (e.key === 'Escape') {
                $('.modal').modal('hide');
            }
        });
    });
</script>

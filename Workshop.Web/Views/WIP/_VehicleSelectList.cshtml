@using Microsoft.Extensions.Localization
@using Workshop.Resources
@model List<Workshop.Core.DTOs.Vehicle.VehicleDefinitions>

@inject IStringLocalizer<Common> Common
@inject IStringLocalizer<Messages> Message

@{
    var lang = "en";
}
<style>
    .vehicle-card {
        border-radius: 15px;
        transition: all 0.25s ease-in;
        cursor: pointer;
    }

        .vehicle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 2px 48px 0 rgb(0 0 0 / 8%);
        }

        .vehicle-card.selected {
            border: 3px solid var(--primary);
            background-color: var(--primary-50);
        }

    .card-overlay {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--primary-400);
        opacity: 0.3;
        border-radius: 15px;
        z-index: 5;
    }

    .selected .card-overlay {
        display: block;
    }

    .check-icon {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 60px;
        color: var(--primary);
        z-index: 6;
    }

    .selected .check-icon {
        display: block;
    }

    .choosebtn {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 7;
    }

    .dashboard-card .card-img-top {
        width: 100%;
        aspect-ratio: 16/9;
        background-size: cover;
        background-position: center;
        border-top-left-radius: .5rem;
        border-top-right-radius: .5rem;
    }

    #vehicleList {
        max-height: 558px;
        overflow-y: auto;
    }

    .select-vehicle-btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
</style>


    @foreach (var item in Model)
    {
        <div class="col-lg-3 mb-4 vehicle-card-container">
            <div class="position-relative vehicle-card bg-subtlelight-fade" data-vehicle-id="@item.Id">
                <input type="radio" class="choosebtn" value="@item.Id" name="selectedVehicleId">
                <div class="card-overlay"></div>
                <i class="fal fa-check-circle check-icon"></i>
                <div class="border dashboard-card position-relative">
                   
                    <div class="card-img-top" style="background-image: url('//wwwroot//images//default_car_260.jpeg');"></div>
                    <div class="card-body">
                        <div class="border-bottom pb-2">
                            <h3 class="text-start card-title mb-2 text-truncate fw-bold">
                                @(lang == "en" ? item.RefManufacturers?.ManufacturerPrimaryName : item.RefManufacturers?.ManufacturerSecondaryName)
                                @(lang == "en" ? item.RefVehicleModels?.VehicleModelPrimaryName : item.RefVehicleModels?.VehicleModelSecondaryName)
                            </h3>
                            <div class="text-start d-flex">
                                <span class="badge bg-primary bg-primary-gradient"><i class="fa fa-calendar"></i>&nbsp;@item.ManufacturingYear</span>
                                <span class="badge bg-primary bg-primary-gradient mx-2" style="padding: 0.17em 0.6em;">
                                    <svg class="align-middle" height="16" viewBox="0 -88 464.008 464" width="16" xmlns="http://www.w3.org/2000/svg" fill="#FFFFFF">
                                        <path d="m432 32.003906h-400v224h400zm-384 16h16v16h-16zm16 192h-16v-16h16zm32-56c13.230469 0 24-10.769531 24-24h16c0 22.054688-17.945312 40-40 40s-40-17.945312-40-40v-32c0-22.054687 17.945312-40 40-40s40 17.945313 40 40h-16c0-13.230468-10.769531-24-24-24s-24 10.769532-24 24v32c0 13.230469 10.769531 24 24 24zm56-48h48v16h-48zm112-8c0 6.167969-2.40625 11.742188-6.238281 16 3.839843 4.257813 6.238281 9.832032 6.238281 16v16c0 13.230469-10.769531 24-24 24h-40v-16h40c4.414062 0 8-3.59375 8-8v-16c0-4.40625-3.585938-8-8-8h-24v-16h24c4.414062 0 8-3.59375 8-8v-16c0-4.40625-3.585938-8-8-8h-40v-16h40c13.230469 0 24 10.769532 24 24zm80 56v16h-64v-19.3125l39.03125-39.03125c5.785156-5.785156 8.96875-13.480468 8.96875-21.65625 0-8.824218-7.175781-16-16-16s-16 7.175782-16 16v8h-16v-8c0-17.648437 14.351562-32 32-32s32 14.351563 32 32c0 12.457032-4.847656 24.167969-13.65625 32.96875l-31.03125 31.03125zm16 0h16v-80h-16v-16h32v96h16v16h-48zm56 56h-16v-16h16zm0-176h-16v-16h16zm0 0"></path>
                                        <path d="m464 .00390625h-464v287.99999975h464.007812zm-16 271.99999975h-432v-256h432zm0 0"></path>
                                    </svg>
                                    @item.PlateNumber
                                </span>
                            </div>
                        </div>
                        <div>
                            <h5 class="text-secondary text-start">@Common["Status"] :<span class="text-primary fs-md float-end">@((lang == "en" ? item.RefVehicleStatus?.VehicleStatusPrimaryName : item.RefVehicleStatus?.VehicleStatusSecondaryName) ?? "N/A")</span></h5>
                            <h5 class="text-secondary text-start">@Common["Color"] :<span class="text-primary fs-md float-end">@((lang == "en" ? item.RefVehicleColor?.VehiclePrimaryName : item.RefVehicleColor?.VehicleSecondaryName) ?? "N/A")</span></h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

<div class="justify-content-center mt-3">
    <button type="button" class="btn btn-primary" id="selectVehicleButton" disabled>@Common["SelectThisVehicle"]</button>
</div>

<script>
    $(document).ready(function () {
        let selectedVehicleId = null;
        const $wipFormWrapper = $('#wipFormWrapper');
        const $vehicleSearchWrapper = $('#vehicleSearchWrapper');
        const $btnFindVehicle = $('#btnFindVehicle');
        const $btnBackToWip = $('#btnBackToWip');

        // Vehicle selection handler
        $('.choosebtn').on('click', function () {
            const vehicleId = $(this).val();
            selectVehicle(vehicleId);
        });

        // Card click handler (alternative to radio button)
        $('.vehicle-card').on('click', function (e) {
            // Don't trigger if the click is on the radio button itself
            if (!$(e.target).is('.choosebtn')) {
                const vehicleId = $(this).data('vehicle-id');
                selectVehicle(vehicleId);
                // Trigger the radio button click to ensure consistency
                $(this).find('.choosebtn').prop('checked', true);
            }
        });

        function selectVehicle(vehicleId) {
            // Remove selection from all vehicles
            $('.vehicle-card').removeClass('selected');
            $('.choosebtn').prop('checked', false);

            // Add selection to clicked vehicle
            $(`.vehicle-card[data-vehicle-id="${vehicleId}"]`).addClass('selected');
            $(`input[value="${vehicleId}"]`).prop('checked', true);

            // Update selected vehicle ID
            selectedVehicleId = vehicleId;

            // Enable the select button
            $('#selectVehicleButton').prop('disabled', false);
        }

        function hideSearchView() {
            $wipFormWrapper.removeClass('d-none');
            $vehicleSearchWrapper.addClass('d-none');
            $btnBackToWip.removeClass('d-none');
        }

        // Final selection handler
        $('#selectVehicleButton').on('click', function () {
            if (selectedVehicleId) {
                // Call parent window function to handle the selected vehicle
                if (window.parent && window.parent.handleVehicleSelection) {
                    window.parent.handleVehicleSelection(selectedVehicleId);
                } else {
                    // Fallback: trigger event or use data attributes
                    $(document).trigger('vehicleSelected', [selectedVehicleId]);
                  
                    $.ajax({
                        url: '/WIP/GetPlateNumber',
                        method: 'GET',
                        dataType: 'json',
                        data: { vehicleId: selectedVehicleId },
                        success: function (result) {
                            // $("#VehicleId").val(result);
                             $("#VehicleId").empty();
                              $("#VehicleId").val(result).attr("data-id", selectedVehicleId);
                             
                        }
                    });
                    
                     hideSearchView()
                }
            }
        });

        
        // Keyboard navigation support
        $(document).on('keydown', function (e) {
            if (e.key === 'Escape') {
                $('.modal').modal('hide');
            }
        });
    });
</script>